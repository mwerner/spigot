<!DOCTYPE html>
<html>
  <head>
    <title>Spigot</title>
    <meta name="author" content="Matthew Werner">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Spigot : A library which provides a clean interface translating API data into context relevant objects" />
    <link href='http://fonts.googleapis.com/css?family=Lato:400,900' rel='stylesheet' type='text/css'>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/highlight.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link rel="shortcut icon" href="#">
  </head>

  <body>
    <div class="top">
      <header>
        <div class="container">
          <div class="row">
            <div class="col-md-6">
              <div class="logo" style="display:none">
                <h1><a href="index.html">Spigot <span class="tblue icon-tint"></span></a></h1>
              </div>
            </div>
            <div class="navigation pull-right">
              <ul class="nav nav-tabs">
                <li style="display:none"><a href="#hero">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#examples">Examples</a></li>
                <li><a href="#docs">Docs</a></li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <div id="hero" class="hero" data-0="background-position:0px 0px;">
        <div class="container">
          <div class="row">
            <div class="col-md-8">
              <div class="intro">
                <div class="logo">
                  <h1>Spigot <span class="tblue icon-tint"></span></h1>
                </div>

                <p>Easily convert API data into context relevant objects</p><br />
                <div class="applinks well">
                  <p><a href="https://github.com/mwerner/spigot" class="btn btn-primary">
                    <i class="icon-github-square"> View on Github</i>
                  </a></p>

                  <p class="actionbuttons">
                    <iframe src="http://ghbtns.com/github-btn.html?user=mwerner&repo=spigot&type=fork"
                      allowtransparency="true" frameborder="0" scrolling="0" width="62" height="20"></iframe>

                    <iframe src="http://ghbtns.com/github-btn.html?user=mwerner&repo=spigot&type=watch&count=true"
                      allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>

                    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="en">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="features">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div id="about" class="text-center">
              <p>
                Spigot is an attempt to bring some sanity to consuming external API data.
                Removing the need for manual ad hoc attribute mapping throughout your code.</p>
              <hr />
              <div class="row">
                <div class="col-md-5  col-xs-6">
                  <p>Without spigot, you may have some creation code such as this.</p>
                  <br />
                  <p>
                    You're usually pulling specific data out of the response, not using half of what you get back, digging through keys and values and checking presence all over the place. These problems get multiplied when you have multiple external sources for your model.
                  </p>
                  <br />
                  <p>
                  You end up with a ton of code just to get the data to fit our model.
                  </p>
                </div>
                <div class="col-md-7  col-xs-6">
                  <pre><code data-language="ruby">if params[:data].present?
  data = params[:data]
  record = User.where(external_id: data[:id]).first

  if record.nil?
    url = "https://github.com/#{data[:login]}"

    user = User.new({
      name: data[:first_name],
      email: data[:email_address],
      url: url
    })

    if data[:profile].present?
      user.bio = data[:profile][:text]
    end

    user.save!
  end
  # gross
end</code></pre>
                </div>
              </div>


              <div class="row">
                <div class="col-md-7  col-xs-6">
                  <pre><code data-language="ruby"># ./config/initializers/spigot.rb
Spigot.resource :user do
  first_name    :name
  email_address :email
  profile do
    text :bio
  end

  url :login do |value|
    "https://github.com/#{value}"
  end
end</code></pre>
                </div>
                <div class="col-md-5  col-xs-6">
                  <p>
                    While using Spigot, you only need to define your map using simple ruby in an initializer and the task of wrangling this data gets much more manageable.
                  </p>
                  <p>
                    Spigot is able to do the translation for you and put the API data into a language your implementation understands.
                  </p>
                </div>
              </div>

              <div class="row">
                <div class="col-md-12  col-xs-6">
                  <p>This leaves you with a simple statement to accomplish the same task:</p>
                  <pre><code data-language="ruby">User.find_or_create_by_api(params[:data])</code></pre>
                  <p>Much better.</p>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="shots">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="shotcontent">
              <h3 id="examples">Examples</h3>

              <div class="row">
                <div class="col-md-12 col-xs-6">
                  <div class="shot-content-body">
                    <h4><i class="icon-tint tblue"></i> Basic Implementation</h4>
                    <p>
                      <pre><code data-language="ruby"># Our Model
class User < ActiveRecord::Base
  include Spigot::Base
end

# Api Data Received
data = JSON.parse("{\"full_name\":\"Dean Martin\",\"login\":\"dino@amore.io\",\"token\":\"abc123\"}")

# Spigot definition to map the data
Spigot.define do
  service :github do
    resource :user do
      full_name :name
      login     :email
      token     :auth
    end
  end
end

# Usage
User.create_by_api({github: data}).inspect
#=> User:0x007f976 id: 1, name: "Dean Martin", email: "dino@amore.io", auth: "abc123"</code></pre>
                    </p>
                  </div>
                </div>
              </div>

              <hr />

              <div class="row">
                <div class="col-md-12 col-xs-6">
                  <div class="shot-content-body">
                    <h4><i class="icon-unlock-alt tblue"></i> Authentication</h4>
                    <p>
                      <pre><code data-language="ruby">Spigot.define do
  service :github do
    resource :user do
      login :username
      name :name
      image(:gravatar_id){|id| "https://2.gravatar.com/avatar/#{id}" }
    end
  end
end

# Using Omniauth
class CallbacksController < Devise::OmniauthCallbacksController

  def github
    user = User.create_or_update_by_api({omniauth: request.env['omniauth.auth']})
    sign_in(:user, user)
    redirect_to dashboard_path
  end

end</code></pre>
                    </p>
                  </div>
                </div>
              </div>

              <hr />

              <div class="row">
                <div class="col-md-12 col-xs-6">
                  <div class="shot-content-body">
                    <h4><i class="icon-puzzle-piece tblue"></i> Coordinating Sources</h4>
                    <p>
                      <pre><code data-language="ruby"># ./config/initializers/spigot.rb
Spigot.define do
  service :github do
    resource :user do
      name  :name
      login :username
      gravatar_id(:image_url){|id| "https://2.gravatar.com/avatar/#{id}" }
    end
  end

  service :twitter do
    resource :user do
      name        :name
      description :bio
      screen_name :username
      profile_image_url :image_url
    end
  end
end

# ./app/models/message.rb
class Message
  after_create :fill_author_data

  def api_data
    # API Calls ...
  end

  def fill_author_data
    user = User.find_or_create_by_api({self.network => api_data})
    update_attribute(:user_id, user.id)
  end
end

# ./app/controllers/messages_controller.rb
class MessagesController < ApplicationController

  def create
    Message.create(params[:message])
  end

end</code></pre>
                    </p>
                  </div>
                </div>
              </div>



            </div>
          </div>

        </div>
        <hr>

        <div class="row">
          <div class="shotcontent">
            <h3 id="docs">Documentation</h3>
          </div>
          <div class="col-md-4 col-sm-4 col-xs-4">
            <div class="well">
              <ul class="list-unstyled nav nav-pills nav-stacked">
                <li class="active"><a href="#syntax" data-toggle="tab">Syntax</a></li>
                <li><a href="#methods" data-toggle="tab">Methods</a></li>
                <li><a href="#services" data-toggle="tab">Services</a></li>
                <li><a href="#resources" data-toggle="tab">Resources</a></li>
                <li><a href="#nested" data-toggle="tab">Nested Data</a></li>
                <li><a href="#proc" data-toggle="tab">Evaluated Ruby</a></li>
                <li><a href="#options" data-toggle="tab">Options</a></li>
              </ul>
            </div>
          </div>

          <div class="col-md-8 col-sm-8 col-xs-12">
            <div class="tab-content">
              <div class="tab-pane active" id="syntax">
                <h3>Syntax</h3>
                <hr />
                <p>
                  We define the map used to translate api data by passing a block to the
                  <code>Spigot.define</code> method.
                </p>
                <pre><code data-language="ruby">Spigot.define do
  service :github do
    resource :user do
      name  :name
      login :username
    end
  end
end</pre></code>
                <p>
                  This map defines the data attributes for a User received from Github.
                  The data received has the keys <code>:name</code> and <code>:login</code>.
                  The values at those keys are mapped to the columns <code>:name</code> and
                  <code>:username</code> respectively.
                </p>
              </div>

              <div class="tab-pane" id="methods">
                <h3>Methods</h3>
                <hr />
                <p>
                  Each ActiveRecord method has a similar signature. Each accepts a hash of data, if you want to scope your data to a specific service, pass the data in as a value keyed to the service name <code>{'username' => 'dino'}</code> vs. <code>{ github: {'username' => 'dino'} }</code>.
                </p>
                <p>
                  You specify the attribute used in your query by assigning the <code>primary_key</code> option in your Spigot definition.
                </p>
                <dl>
                  <dt><code>find_by_api</code></dt>
                  <dt><code>find_all_by_api</code></dt>
                  <dt><code>create_by_api</code></dt>
                  <dt><code>update_by_api</code></dt>
                  <dt><code>find_or_create_by_api</code></dt>
                  <dt><code>create_or_update_by_api</code></dt>
                </dl>
                <pre><code data-language="ruby"># Spigot Definition
Spigot.resource :user do
  full_name :name
  login     :email
  token     :auth
  options do
    primary_key :email
  end
end

# API Data
data = {"full_name":"Dean","login":"dino@amore.io","token":"bcd456"}

User.find_by_api(data)</code>
<code data-language='sql'>User Load (0.1ms)  SELECT "users".* FROM "users" WHERE "users"."email" = 'dino@amore.io' ORDER BY "users"."id" ASC LIMIT 1</code>
<code>#=> User id: 1, name: "Dean Martin", email: "dino@amore.io", token: "abc123"</code></pre>
              </div>

              <div class="tab-pane" id="services">
                <h3>Services</h3>
                <hr />
                <p>
                  Spigot definitions have a <code>service</code> keyword. You can pass it a name
                  and then a block of <code>resource</code> definitions. Each service denotes a different
                  source of API data, such as Twitter or Github. You can also call service on the `Spigot` object without the define method.
                </p>
                <pre><code data-language="ruby">Spigot.define do
  service :twitter do
    ...
  end
end

Spigot.service :yelp do
  resource :review do
    ...
  end
end</code></pre>
              </div>

              <div class="tab-pane" id="resources">
                <h3>Resources</h3>
                <hr />
                <p>
                  Spigot definitions have a <code>resource</code> keyword. This corresponds to the name of the class that is implementing this map. Spigot uses the resource name to look up which map to use for the class you're currently mixing Spigot into.
                </p>

                <p>
                  In this code block, we are defining a service for the Twitter API. When we pass twitter data to a spigot method used on the <code>User</code> class, it will use the mapping defined in the <code>:user</code> resource.
                </p>

                <p>
                  If you define a resource without enclosing it in a service, it will use this map whenever you don't specify which service to use as you pass the data in.
                </p>
                <pre><code data-language="ruby">Spigot.define do
  service :twitter do
    resource :user do
      ...
    end
  end
end

Spigot.resource(:tweet) do
  ...
end</code></pre>
              </div>

              <div class="tab-pane" id="nested">
                <h3>Nested Data</h3>
                <hr />
                <p>
                  The data received from an API is often nested. We can convey this using a nested block within a resource definition.
                </p>

                <p>In this code block, we are mapping data that has a <code>contact</code> key that points to a nested hash containing data with keys <code>login</code> and <code>phone</code>. We will drill down into the <code>contact</code> hash and map those corresponding values to the appropriate attributes in our formatted hash.</p>
                <pre><code data-language="ruby">Spigot.resource :user do
  full_name :name
  contact do
    login :email
    phone :telephone
  end
end</code></pre>
              </div>

              <div class="tab-pane" id="proc">
                <h3>Evaluated Ruby</h3>
                <hr />
                <p>
                  On any attribute map, you're able to pass it a block which will be used during the assignment of the value. This let's you modify the value before assignment to the attribute in the formatted hash.
                </p>

                <p>In this code block, we are taking the value that is present in the API data under the <code>username</code> key and interpolating the value into a static url to build our database's value for the user's URL</p>
                <pre><code data-language="ruby">Spigot.resource(:user) do
  full_name :name
  username :url do |value|
    "https://twitter.com/#{value}"
  end
end</code></pre>
              </div>

              <div class="tab-pane" id="options">
                <h3>Options</h3>
                <hr />
                <p>
                  There are a couple options available to help define how Spigot accomplishes various tasks. Right now this is limited to database queries. Each Spigot option set is defined per resource.
                </p>

                <dl>
                  <dt><code>primary_key</code></dt>
                  <dd>The attribute used to execute a select statement when querying this resource's table</dd>
                </dl>
                <pre><code data-language="ruby">Spigot.resource(:user) do
  full_name :name
  login :email
  options do
    primary_key :email
  end
end</code></pre>
              </div>

            </div>
          </div>

        </div>

      </div>

    </div>

    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="copy text-center">
              &copy; 2013 <a href="index.html">Spigot</a>
              <a href="https://travis-ci.org/mwerner/spigot">
                <img src="https://travis-ci.org/mwerner/spigot.png?branch=master" alt="Build Status" style="max-width:100%;">
              </a>
              <a href="https://codeclimate.com/github/mwerner/spigot">
                <img src="https://codeclimate.com/github/mwerner/spigot.png" alt="Code Climate" style="max-width:100%;">
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script src="js/jquery.js"></script>
    <script src="js/vendor/mousewheel.jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/respond.min.js"></script>
    <script src="js/html5shiv.js"></script>
    <script src="js/custom.js"></script>
    <script src="js/vendor/rainbow/rainbow.js"></script>
    <script src="js/vendor/rainbow/ruby.js"></script>
    <script src="js/vendor/rainbow/generic.js"></script>
  </body>
</html>
